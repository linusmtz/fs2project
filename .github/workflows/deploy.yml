name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: self-hosted  # Cambia esto por el label de tu runner si es diferente
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy code to deployment directory
        run: |
          set -e
          APP_DIR="/home/ubuntu/fs2Project"
          mkdir -p "$APP_DIR"
          
          echo "ðŸ“¦ Copiando cÃ³digo al directorio de deployment..."
          # Copiar todo el cÃ³digo desde el workspace del runner al directorio de deployment
          rsync -av --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            "$GITHUB_WORKSPACE/" "$APP_DIR/"
          
          echo "APP_DIR=$APP_DIR" >> $GITHUB_ENV
          echo "âœ… CÃ³digo copiado exitosamente"

      - name: Create .env file from GitHub Secrets
        run: |
          set -e
          cd "$APP_DIR"
          
          echo "ðŸ“ Creando archivo .env desde GitHub Secrets..."
          
          # Crear el archivo .env con todas las variables de los secrets
          cat > src/.env << 'ENVEOF'
          # Django Settings
          SECRET_KEY=$SECRET_KEY_VAR
          DEBUG=$DEBUG_VAR
          ALLOWED_HOSTS=$ALLOWED_HOSTS_VAR
          CSRF_TRUSTED_ORIGINS=$CSRF_TRUSTED_ORIGINS_VAR
          
          # Database Configuration
          DJANGO_USE_SQLITE=$DJANGO_USE_SQLITE_VAR
          POSTGRES_DB=$POSTGRES_DB_VAR
          POSTGRES_USER=$POSTGRES_USER_VAR
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD_VAR
          POSTGRES_HOST=$POSTGRES_HOST_VAR
          POSTGRES_PORT=$POSTGRES_PORT_VAR
          
          # Cloud Storage (OCI Object Storage)
          USE_CLOUD_STORAGE=$USE_CLOUD_STORAGE_VAR
          AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_VAR
          AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_VAR
          AWS_STORAGE_BUCKET_NAME=$AWS_STORAGE_BUCKET_NAME_VAR
          AWS_S3_REGION_NAME=$AWS_S3_REGION_NAME_VAR
          AWS_S3_ENDPOINT_URL=$AWS_S3_ENDPOINT_URL_VAR
          
          # Optional Settings
          TIME_ZONE=$TIME_ZONE_VAR
          
          # Email Configuration
          EMAIL_BACKEND=$EMAIL_BACKEND_VAR
          EMAIL_HOST=$EMAIL_HOST_VAR
          EMAIL_PORT=$EMAIL_PORT_VAR
          EMAIL_USE_TLS=$EMAIL_USE_TLS_VAR
          EMAIL_USE_SSL=$EMAIL_USE_SSL_VAR
          EMAIL_HOST_USER=$EMAIL_HOST_USER_VAR
          EMAIL_HOST_PASSWORD=$EMAIL_HOST_PASSWORD_VAR
          DEFAULT_FROM_EMAIL=$DEFAULT_FROM_EMAIL_VAR
          EMAIL_TIMEOUT=$EMAIL_TIMEOUT_VAR
          ENVEOF
          
          # Reemplazar las variables con los valores reales de los secrets
          sed -i "s|\$SECRET_KEY_VAR|${{ secrets.SECRET_KEY }}|g" src/.env
          sed -i "s|\$DEBUG_VAR|${{ secrets.DEBUG || '0' }}|g" src/.env
          sed -i "s|\$ALLOWED_HOSTS_VAR|${{ secrets.ALLOWED_HOSTS }}|g" src/.env
          sed -i "s|\$CSRF_TRUSTED_ORIGINS_VAR|${{ secrets.CSRF_TRUSTED_ORIGINS }}|g" src/.env
          sed -i "s|\$DJANGO_USE_SQLITE_VAR|${{ secrets.DJANGO_USE_SQLITE || '0' }}|g" src/.env
          sed -i "s|\$POSTGRES_DB_VAR|${{ secrets.POSTGRES_DB }}|g" src/.env
          sed -i "s|\$POSTGRES_USER_VAR|${{ secrets.POSTGRES_USER }}|g" src/.env
          sed -i "s|\$POSTGRES_PASSWORD_VAR|${{ secrets.POSTGRES_PASSWORD }}|g" src/.env
          sed -i "s|\$POSTGRES_HOST_VAR|${{ secrets.POSTGRES_HOST || 'db' }}|g" src/.env
          sed -i "s|\$POSTGRES_PORT_VAR|${{ secrets.POSTGRES_PORT || '5432' }}|g" src/.env
          sed -i "s|\$USE_CLOUD_STORAGE_VAR|${{ secrets.USE_CLOUD_STORAGE || '1' }}|g" src/.env
          sed -i "s|\$AWS_ACCESS_KEY_ID_VAR|${{ secrets.AWS_ACCESS_KEY_ID }}|g" src/.env
          sed -i "s|\$AWS_SECRET_ACCESS_KEY_VAR|${{ secrets.AWS_SECRET_ACCESS_KEY }}|g" src/.env
          sed -i "s|\$AWS_STORAGE_BUCKET_NAME_VAR|${{ secrets.AWS_STORAGE_BUCKET_NAME }}|g" src/.env
          sed -i "s|\$AWS_S3_REGION_NAME_VAR|${{ secrets.AWS_S3_REGION_NAME }}|g" src/.env
          sed -i "s|\$AWS_S3_ENDPOINT_URL_VAR|${{ secrets.AWS_S3_ENDPOINT_URL }}|g" src/.env
          sed -i "s|\$TIME_ZONE_VAR|${{ secrets.TIME_ZONE || 'America/Mexico_City' }}|g" src/.env
          sed -i "s|\$EMAIL_BACKEND_VAR|${{ secrets.EMAIL_BACKEND || 'django.core.mail.backends.console.EmailBackend' }}|g" src/.env
          sed -i "s|\$EMAIL_HOST_VAR|${{ secrets.EMAIL_HOST || '' }}|g" src/.env
          sed -i "s|\$EMAIL_PORT_VAR|${{ secrets.EMAIL_PORT || '587' }}|g" src/.env
          sed -i "s|\$EMAIL_USE_TLS_VAR|${{ secrets.EMAIL_USE_TLS || 'True' }}|g" src/.env
          sed -i "s|\$EMAIL_USE_SSL_VAR|${{ secrets.EMAIL_USE_SSL || 'False' }}|g" src/.env
          sed -i "s|\$EMAIL_HOST_USER_VAR|${{ secrets.EMAIL_HOST_USER || '' }}|g" src/.env
          sed -i "s|\$EMAIL_HOST_PASSWORD_VAR|${{ secrets.EMAIL_HOST_PASSWORD || '' }}|g" src/.env
          sed -i "s|\$DEFAULT_FROM_EMAIL_VAR|${{ secrets.DEFAULT_FROM_EMAIL || 'noreply@example.com' }}|g" src/.env
          sed -i "s|\$EMAIL_TIMEOUT_VAR|${{ secrets.EMAIL_TIMEOUT || '10' }}|g" src/.env
          
          # Verificar que las variables crÃ­ticas estÃ©n configuradas
          echo "ðŸ” Verificando variables crÃ­ticas..."
          
          REQUIRED_VARS=(
            "SECRET_KEY"
            "ALLOWED_HOSTS"
            "POSTGRES_DB"
            "POSTGRES_USER"
            "POSTGRES_PASSWORD"
            "AWS_ACCESS_KEY_ID"
            "AWS_SECRET_ACCESS_KEY"
            "AWS_STORAGE_BUCKET_NAME"
            "AWS_S3_REGION_NAME"
            "AWS_S3_ENDPOINT_URL"
          )
          
          MISSING_VARS=()
          for var in "${REQUIRED_VARS[@]}"; do
            if ! grep -q "^${var}=" src/.env || grep -q "^${var}=$" src/.env || grep -q "^${var}=\${{" src/.env; then
              MISSING_VARS+=("$var")
            fi
          done
          
          if [ ${#MISSING_VARS[@]} -gt 0 ]; then
            echo "âŒ ERROR: Faltan las siguientes variables en GitHub Secrets:"
            printf '  - %s\n' "${MISSING_VARS[@]}"
            exit 1
          fi
          
          # Proteger el archivo .env
          chmod 600 src/.env
          echo "âœ… Archivo .env creado exitosamente y protegido"

      - name: Build and start containers
        run: |
          set -e
          cd "$APP_DIR"
          
          echo "ðŸ”¨ Construyendo contenedores..."
          docker compose -f docker-compose.prod.yml build --no-cache
          
          echo "ðŸš€ Levantando contenedores..."
          docker compose -f docker-compose.prod.yml up -d
          
          echo "â³ Esperando a que los servicios estÃ©n listos..."
          sleep 15

      - name: Run migrations
        run: |
          cd "$APP_DIR"
          echo "ðŸ“Š Ejecutando migraciones..."
          docker compose -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput

      - name: Collect static files
        run: |
          cd "$APP_DIR"
          echo "ðŸ“¦ Recopilando archivos estÃ¡ticos..."
          docker compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput

      - name: Verify containers
        run: |
          cd "$APP_DIR"
          echo "âœ… Verificando contenedores..."
          docker compose -f docker-compose.prod.yml ps

      - name: Clean up old images
        run: |
          echo "ðŸ§¹ Limpiando imÃ¡genes antiguas..."
          docker image prune -f

      - name: Verify deployment
        run: |
          sleep 5
          curl -f http://localhost:8000/ || echo "âš ï¸ Advertencia: No se pudo verificar el deployment localmente"
          echo "âœ… Deployment completado exitosamente!"

